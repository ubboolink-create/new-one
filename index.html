<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Inventarisatie magazijn — Webapp</title>
<style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    button { padding: 10px 18px; margin: 6px; font-size: 16px; }
    #preview { width: 100%; background: #000; border-radius: 8px; margin-top: 10px; }
    .status { background: #eee; padding: 10px; margin-top: 10px; border-radius: 8px; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 8px; }
</style>
</head>
<body>
<h2>Inventarisatie magazijn — Webapp</h2>
<p>Korte workflow: <b>Scan locatie → Scan artikel → Voer aantal in → Opslaan → Volgende</b></p>

<div>
    <button id="startBtn">Start telrun</button>
    <button id="stopBtn">Stop</button>
    <button id="manualBtn">Handmatig toevoegen</button>
    <button id="exportCsvBtn">Export .csv</button>
    <button id="exportXlsxBtn">Export .xlsx</button>
    <button id="clearBtn">Wis alle regels</button>
</div>

<div id="status" class="status">Status: klaar</div>

<video id="preview" playsinline></video>

<br />
<label>Huidige locatie: <input id="locInput" /></label><br />
<label>Huidig artikel: <input id="artInput" /></label><br />
<label>Aantal: <input id="qtyInput" type="number" /></label>
<button id="saveRowBtn">Opslaan regel</button>

<table>
<thead>
<tr><th>#</th><th>Tijd</th><th>Locatie</th><th>Artikel</th><th>Aantal</th><th>Acties</th></tr>
</thead>
<tbody id="rows"></tbody>
</table>

<script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
<script>
let stream = null;
let reader = null;
let scanning = false;
let rowIndex = 1;

function status(msg) {
    document.getElementById("status").innerText = "Status: " + msg;
}

async function startCamera() {
    try {
        const constraints = {
            video: { facingMode: { ideal: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 } },
            audio: false
        };

        stream = await navigator.mediaDevices.getUserMedia(constraints);
        const videoElem = document.getElementById("preview");
        videoElem.srcObject = stream;
        await videoElem.play();
        status("Camera gestart");
        return videoElem;
    } catch (err) {
        console.error(err);
        status("Fout bij starten camera: " + err.message);
    }
}

async function startScan() {
    if (scanning) {
        status("Flow draait al");
        return;
    }
    scanning = true;

    const videoElem = await startCamera();
    if (!videoElem) return;

    reader = new ZXing.BrowserMultiFormatReader();

    const loopScan = async () => {
        if (!scanning) return;
        try {
            const result = await reader.decodeOnceFromVideoElement(videoElem);
            if (result && result.text) {
                status("Scan gedetecteerd: " + result.text);

                // Toon scan in juiste veld afhankelijk van fase
                const locField = document.getElementById("locInput");
                const artField = document.getElementById("artInput");

                if (!locField.value) locField.value = result.text;
                else if (!artField.value) artField.value = result.text;

                // opnieuw scannen
                setTimeout(loopScan, 600);
            }
        } catch (err) {
            setTimeout(loopScan, 600);
        }
    };

    loopScan();
}

function stopScan() {
    scanning = false;
    if (reader) reader.reset();
    if (stream) stream.getTracks().forEach(t => t.stop());
    status("Gestopt");
}

document.getElementById("startBtn").onclick = startScan;
document.getElementById("stopBtn").onclick = stopScan;

document.getElementById("saveRowBtn").onclick = () => {
    const loc = document.getElementById("locInput").value;
    const art = document.getElementById("artInput").value;
    const qty = document.getElementById("qtyInput").value;

    if (!loc || !art || !qty) {
        status("Vul locatie, artikel en aantal in");
        return;
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td>${rowIndex}</td>
        <td>${new Date().toLocaleTimeString()}</td>
        <td>${loc}</td>
        <td>${art}</td>
        <td>${qty}</td>
        <td><button onclick="this.parentElement.parentElement.remove()">Verwijder</button></td>
    `;
    document.getElementById("rows").appendChild(tr);
    rowIndex++;

    document.getElementById("locInput").value = "";
    document.getElementById("artInput").value = "";
    document.getElementById("qtyInput").value = "";

    status("Regel opgeslagen");
};
</script>

</body>
</html>
