<script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
let stream = null;
let reader = null;
let scanning = false;
let rowIndex = 1;
let scanPhase = "locatie"; // "locatie" of "artikel"

function status(msg) {
    document.getElementById("status").innerText = "Status: " + msg;
}

async function startCamera() {
    try {
        const constraints = {
            video: { facingMode: { ideal: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 } },
            audio: false
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        const videoElem = document.getElementById("preview");
        videoElem.srcObject = stream;
        await videoElem.play();
        status("Camera gestart");
        return videoElem;
    } catch (err) {
        console.error(err);
        status("Fout bij starten camera: " + err.message);
    }
}

async function startScan() {
    if (scanning) {
        status("Flow draait al");
        return;
    }
    scanning = true;
    const videoElem = await startCamera();
    if (!videoElem) return;

    reader = new ZXing.BrowserMultiFormatReader();

    const loopScan = async () => {
        if (!scanning) return;
        try {
            const result = await reader.decodeOnceFromVideoElement(videoElem);
            if (result && result.text) {
                status("Scan gedetecteerd: " + result.text);

                if (scanPhase === "locatie") {
                    document.getElementById("locInput").value = result.text;
                    scanPhase = "artikel";
                    status("Scan artikel nu");
                } else if (scanPhase === "artikel") {
                    document.getElementById("artInput").value = result.text;
                    scanPhase = "locatie";
                    status("Voer aantal in en klik Opslaan");
                }

                setTimeout(loopScan, 600);
            } else {
                setTimeout(loopScan, 600);
            }
        } catch (err) {
            setTimeout(loopScan, 600);
        }
    };

    loopScan();
}

function stopScan() {
    scanning = false;
    if (reader) reader.reset();
    if (stream) stream.getTracks().forEach(t => t.stop());
    status("Gestopt");
}

document.getElementById("startBtn").onclick = startScan;
document.getElementById("stopBtn").onclick = stopScan;

document.getElementById("saveRowBtn").onclick = () => {
    const loc = document.getElementById("locInput").value;
    const art = document.getElementById("artInput").value;
    const qty = document.getElementById("qtyInput").value;

    if (!loc || !art || !qty) {
        status("Vul locatie, artikel en aantal in");
        return;
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td>${rowIndex}</td>
        <td>${new Date().toLocaleTimeString()}</td>
        <td>${loc}</td>
        <td>${art}</td>
        <td>${qty}</td>
        <td><button onclick="this.parentElement.parentElement.remove()">Verwijder</button></td>
    `;
    document.getElementById("rows").appendChild(tr);
    rowIndex++;

    document.getElementById("locInput").value = "";
    document.getElementById("artInput").value = "";
    document.getElementById("qtyInput").value = "";
    document.getElementById("locInput").focus();

    status("Regel opgeslagen");
};

// Export naar XLSX
document.getElementById("exportXlsxBtn").onclick = () => {
    const wb = XLSX.utils.book_new();
    const wsData = [["#", "Tijd", "Locatie", "Artikel", "Aantal"]];
    document.querySelectorAll("#rows tr").forEach(tr => {
        wsData.push(Array.from(tr.children).slice(0,5).map(td => td.innerText));
    });
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, "Inventarisatie");
    XLSX.writeFile(wb, "inventarisatie.xlsx");
};
</script>
